<!DOCTYPE HTML>
<html>
<head>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script type="text/javascript" src="canvasjs/canvasjs.min.js"></script>
	<script type="text/javascript">

	var cgmresults;
	var jsonsource = "./cgmresults.json";

	window.onload = function () {
		var chart;
		var dps, dpsavg;   //dataPoints. 
                var tem;
		var timeFrame = 576;
		var updateInterval = 300000;
		var averageInterval = 1;

		$.getJSON(jsonsource, function(data) {
			cgmresults = data;
			createData();
			updateData();
			createChart();
			renderChart();
			setInterval(function(){updateChart()}, updateInterval);
		});

		var createData = function () {
			var h, g;

			dps = [];
			dpsavg = [];
			tem = [];


			for (h=0; h<cgmresults.hosts.length; h++) {
				dps[h] = [];
				dpsavg[h] = [];
				tem[h] = [];

				for (g=0; g<cgmresults.hosts[h].Devs.DEVS.length; g++) {
					dps[h][g] = [];
					tem[h][g] = [];
				};
			};
		};

		var updateData = function () {
		        var i, g, h, r, t, avg, c, hashrateconst = 65.536;

			for (h=0; h<cgmresults.hosts.length; h++) {
				for (g=0; g<cgmresults.hosts[h].Devs.DEVS.length; g++) {
					if (cgmresults.hosts[h].Devs.DEVS[g]["is hashing"]) {
						avg = 0; c = 0; offset = cgmresults.hosts[h].HashrateHistory[2].length-timeFrame-1;

		       		 		for (i=timeFrame-1, t=cgmresults.hosts[h].HashrateHistory[0][1]-cgmresults.hosts[h].HashrateHistory[0][2]; i >= 0; i--, t -= cgmresults.hosts[h].HashrateHistory[0][2]) {
							r = 0;

							for (j = 0; j <= Math.min(i,averageInterval); j++) {
								rr = cgmresults.hosts[h].HashrateHistory[2][offset+i-j][g];
								if (rr == null) { rr = 0; };
								r += rr;
							};

							r /= j; avg += r; c++;
       		        				dps[h][g][i] = { x: new Date(t*1000), y: Math.round(r*hashrateconst) };
						};

						if (c) avg /= c;

						dpsavg[h][g] = avg*hashrateconst;

		       		 		for (i=timeFrame-1, t=cgmresults.hosts[h].TemperatureHistory[0][1]-cgmresults.hosts[h].TemperatureHistory[0][2]; i >= 0; i--, t -= cgmresults.hosts[h].TemperatureHistory[0][2]) {
							r = cgmresults.hosts[h].TemperatureHistory[2][offset+i][g];

							if ( r == null) { r = 0; } ;

       			        			tem[h][g][i] = { x: new Date(t*1000), y: Math.round(r*10)/10 };
						};
					};
				};
			};
		};

		var createChart = function () {
			var i, h, g, gchart, totalhash, chartindex = 0, chartdata = [], transparency = 0.9;

			chart = [];

			cdm1 = [[121, 28, 135], [110, 28, 144], [100, 29, 153], [90, 30, 161], [80, 30, 170],
				[76, 37, 177], [72, 44, 184], [68, 51, 190], [64, 58, 197], [64, 66, 200],
				[63, 75, 203], [63, 84, 206], [62, 92, 209], [64, 101, 208], [65, 109, 207],
				[67, 117, 206], [68, 125, 205], [71, 131, 201], [73, 137, 197], [76, 144, 193],
				[78, 150, 189], [82, 154, 183], [85, 159, 177], [89, 163, 171], [92, 168, 165],
				[97, 171, 159], [101, 174, 152], [106, 177, 145], [110, 180, 138], [115, 181, 132],
				[121, 183, 126], [126, 185, 119], [131, 187, 113], [137, 188, 108], [143, 189, 102],
				[150, 190, 97], [156, 190, 92], [162, 190, 88], [168, 190, 84], [184, 190, 80],
				[190, 200, 77], [216, 219, 74], [212, 197, 72], [228, 196, 69], [203, 185, 67],
				[208, 181, 65], [212, 178, 64], [217, 175, 62], [221, 172, 61], [223, 166, 59],
				[226, 160, 58], [228, 155, 57], [231, 149, 55], [231, 141, 54], [231, 133, 52],
				[231, 124, 51], [231, 116, 49], [230, 106, 47], [228, 96, 45], [226, 85, 43],
				[225, 75, 41], [223, 65, 39], [222, 54, 37], [221, 44, 36], [219, 34, 34]];

			cdm2 = [[12, 50, 20], [12, 52, 22], [13, 54, 21], [13, 66, 20], [14, 68, 
					19], [14, 70, 18], [15, 72, 17], [16, 84, 16], [16, 86, 15], [17, 
					98, 14], [17, 90, 13], [18, 92, 12], [18, 93, 11], [19, 95, 
					10], [19, 97, 21], [20, 99, 31], [21, 91, 41], [21, 95, 51], [21, 
					109, 52], [21, 113, 42], [22, 118, 33], [22, 112, 23], [22, 116, 
					14], [22, 120, 34], [22, 114, 45], [23, 108, 55], [23, 92, 66], [23, 
					76, 76], [23, 80, 86], [24, 84, 97], [24, 88, 10], [24, 92, 
					18], [24, 96, 128], [24, 101, 13], [24, 105, 14], [25, 109, 
					15], [25, 114, 161], [25, 118, 17], [25, 122, 18], [25, 127, 
					19], [25, 131, 20], [25, 135, 21], [25, 140, 22], [25, 144, 
					23], [25, 148, 24], [25, 153, 23], [25, 157, 22], [25, 161, 
					21], [25, 166, 20], [25, 168, 19], [25, 171, 18], [25, 174, 
					16], [25, 177, 15], [25, 179, 14], [25, 182, 13], [25, 185, 
					12], [25, 188, 117], [25, 191, 107], [25, 193, 98], [25, 196, 
					89], [25, 199, 70], [25, 202, 60], [25, 204, 51], [25, 207, 
					42], [25, 210, 33]];

			$(document.body).append("<h1>CgminerRRD (2013)</h1>");
			$(document.body).append("<p id=\"updatedField\">Updated: "+new Date()+"</p>");
			$(document.body).append("<button id=\"refreshButton\" style=\"background-color:red\">Refresh</button>");
			$("#refreshButton").click( function() {
				updateChart();

			});
			$(document.body).append("<button id=\"timeFrame576Button\" style=\"background-color:orange\">48h</button>");
			$("#timeFrame576Button").click( function() {
				timeFrame = 576;
				document.body.innerHTML = "";
				createData();
				createChart();
				updateChart();

			});
			$(document.body).append("<button id=\"timeFrame288Button\" style=\"background-color:orange\">24h</button>");
			$("#timeFrame288Button").click( function() {
				timeFrame = 288;
				document.body.innerHTML = "";
				createData();
				createChart();
				updateChart();

			});
			$(document.body).append("<button id=\"timeFrame144Button\" style=\"background-color:orange\">12h</button>");
			$("#timeFrame144Button").click( function() {
				timeFrame = 144;
				document.body.innerHTML = "";
				createData();
				createChart();
				updateChart();

			});
			$(document.body).append("<button id=\"timeFrame24Button\" style=\"background-color:orange\">2h</button>");
			$("#timeFrame24Button").click( function() {
				timeFrame = 24;
				document.body.innerHTML = "";
				createData();
				createChart();
				updateChart();

			});
			$(document.body).append("<button id=\"averageIntervalButton1\" style=\"background-color:lightblue\">avg:5m</button>");
			$("#averageIntervalButton1").click( function() {
				averageInterval = 1;
				document.body.innerHTML = "";
				createData();
				createChart();
				updateChart();

			});
			$(document.body).append("<button id=\"averageIntervalButton10\" style=\"background-color:lightblue\">avg:1h</button>");
			$("#averageIntervalButton10").click( function() {
				averageInterval = 12;
				document.body.innerHTML = "";
				createData();
				createChart();
				updateChart();

			});
			$(document.body).append("<button id=\"averageIntervalButton50\" style=\"background-color:lightblue\">avg:6h</button>");
			$("#averageIntervalButton50").click( function() {
				averageInterval = 72;
				document.body.innerHTML = "";
				createData();
				createChart();
				updateChart();

			});

			$(document.body).append("<div id=\"chartContainer"+chartindex+"\" style=\"height: 300px; width: 100%; float: left;\"></div>");
			chartdata[chartindex] = [];
			totalhash = 0;

			for (h=0, gchart=0; h<cgmresults.hosts.length; h++)
				for (g=0; g<cgmresults.hosts[h].Devs.DEVS.length; g++)
					if (cgmresults.hosts[h].Devs.DEVS[g]["is hashing"]) {
						chartdata[chartindex][gchart] = {
							type: "stackedArea",
							name: "GPU"+gchart+" Avg: "+Math.round(dpsavg[h][g]),
							showInLegend: "true",
							dataPoints : dps[h][g]
						};
						totalhash += dpsavg[h][g];
						gchart++;
					};

			for (i=0, g=Math.floor(cdm1.length/gchart); gchart; gchart--, i+=g)
				 chartdata[chartindex][gchart-1].color = "rgba("+cdm1[i][0]+","+cdm1[i][1]+","+cdm1[i][2]+","+transparency+")";

			chart[chartindex] = new CanvasJS.Chart("chartContainer"+chartindex, {
				creditText: "",
				zoomEnabled: true,
				toolTip: {
					shared: "true"
				},
				title :{
					text: "Total average hash rate: "+Math.round(totalhash),
					horizontalAlign: "left"
				},
				axisX: {
				},
				axisY: {
					title: "kH/s"
				},
				legend: {
					verticalAlign: "bottom",
					horizontalAlign: "left",
					fontSize: 12
				},
				data: chartdata[chartindex]
			});


			for (h=0; h<cgmresults.hosts.length; h++) {
				chartindex++;
				$(document.body).append("<div id=\"chartContainer"+chartindex+"\" style=\"height: 260px; width: 50%; float: left;\"></div>");
				chartdata[chartindex] = [];
				totalhash = 0;

				for (g=0, gchart=0; g<cgmresults.hosts[h].Devs.DEVS.length; g++)
					if (cgmresults.hosts[h].Devs.DEVS[g]["is hashing"]) {
						chartdata[chartindex][gchart] = {
							type: "stackedArea",
							name: "GPU"+cgmresults.hosts[h].Devs.DEVS[g].GPU+" Avg: "+Math.round(dpsavg[h][g]),
							showInLegend: "true",
							dataPoints : dps[h][g]
						};
						totalhash += dpsavg[h][g];
						gchart++;
						chartdata[chartindex][gchart] = {
							type: "line",
							axisYType: "secondary",
							name: "GPU"+cgmresults.hosts[h].Devs.DEVS[g].GPU+" Temp",
							dataPoints : tem[h][g]
						};
						gchart++;
					}

				for (g=Math.floor(cdm1.length/gchart*2), i = g-1; gchart; gchart-=2, i+=g) {
					chartdata[chartindex][gchart-2].color = "rgba("+cdm1[i][0]+","+cdm1[i][1]+","+cdm1[i][2]+","+transparency+")";
					chartdata[chartindex][gchart-1].color = "rgba("+cdm2[i][0]+","+cdm2[i][1]+","+cdm2[i][2]+","+transparency+")";
				};

				chart[chartindex] = new CanvasJS.Chart("chartContainer"+chartindex, {
					creditText: "",
					zoomEnabled: true,
					toolTip: {
						shared: "true"
					},
					title :{
						text: cgmresults.hosts[h].hostname+":"+cgmresults.hosts[h].port+", Avg. rate: "+Math.round(totalhash),
						horizontalAlign: "left"
					},
					axisX: {
					},
					axisY: {						
						title: "kH/s"
					},
					axisY2: {						
						title: "Deg. C",
						minimum: 70,
						maximum: 90
					},
					legend: {
						verticalAlign: "bottom",
						horizontalAlign: "left",
						fontSize: 12
					},
					data: chartdata[chartindex]
				});
			};
		};

		var renderChart = function () {
			var h, g, chartindex = 0, gchart, totalhash;

			for (h=0, gchart=0, totalhash = 0; h<cgmresults.hosts.length; h++)
				for (g=0; g<cgmresults.hosts[h].Devs.DEVS.length; g++)
					if (cgmresults.hosts[h].Devs.DEVS[g]["is hashing"]) {
						chart[chartindex].options.data[gchart].name = "GPU"+gchart+" Avg: "+Math.round(dpsavg[h][g]);
						gchart++;
						totalhash += dpsavg[h][g];
					};

			chart[chartindex].options.title.text = "Total average hash rate: "+Math.round(totalhash);

			for (h=0; h<cgmresults.hosts.length; h++) {
				chartindex++;

				for (g=0, gchart=0, totalhash=0; g<cgmresults.hosts[h].Devs.DEVS.length; g++)
					if (cgmresults.hosts[h].Devs.DEVS[g]["is hashing"]) {
						chart[chartindex].options.data[gchart].name = "GPU"+cgmresults.hosts[h].Devs.DEVS[g].GPU+" Avg: "+Math.round(dpsavg[h][g]);
						totalhash += dpsavg[h][g];
						gchart += 2;
					};

				chart[chartindex].options.title.text = cgmresults.hosts[h].hostname+":"+cgmresults.hosts[h].port+", Avg. rate: "+Math.round(totalhash);
			};

			for (h=0; h<chart.length; h++) {
				chart[h].render();
			};		
		};

		var updateChart = function () {
			$.getJSON(jsonsource, function(data) {
				cgmresults = data;
				updateData();
				renderChart();
				document.getElementById("updatedField").innerHTML = "Updated: "+new Date()+", timeFrame: "+timeFrame+", averageInterval: "+averageInterval;
			});
		};
	}

</script>
</head>
<body>
</body>
</html>
